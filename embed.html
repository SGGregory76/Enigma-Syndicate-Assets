<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Enigma Syndicate Embed</title>
  <style>
    /* optional: ensure full-width card */
    #game-root { width:100%; max-width:400px; margin:0; }
  </style>
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Assets base URL -->
  <script>
    window.ASSETS_BASE_URL = 'https://SGGregory76.github.io/Enigma-Syndicate-Assets';
  </script>
</head>
<body>
  <!-- only this container -->
  <div id="game-root"></div>

  <!-- inline engine (same as demo, minus errors/pre) -->
  <script>
  (async function(){
    // init Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyCiFF0giW60YhEF9MPF8RMMETXkNW9vv2Y",
      authDomain: "sandbox-mafia.firebaseapp.com",
      databaseURL: "https://sandbox-mafia-default-rtdb.firebaseio.com",
      projectId: "sandbox-mafia",
      storageBucket: "sandbox-mafia.firebasestorage.app",
      messagingSenderId: "966783573980",
      appId: "1:966783573980:web:a07a7b66d7d9a057dab919"
    });
    const auth = firebase.auth(), db = firebase.database();
    let uid;
    function xpToLevel(xp){ return Math.floor(xp/100)+1; }
    await new Promise(r=> auth.onAuthStateChanged(u=>u?(uid=u.uid,r()):auth.signInAnonymously().then(c=>{uid=c.user.uid;r()})));

    // inline card meta
    const cardMeta = {
      "vito_the_intimidator": { faction:"enforcers" },
      "lola_the_quick":       { faction:"undercutters" },
      "bruno_the_tank":       { faction:"syndicate" }
    };

    // seed player
    let player = await db.ref(`/players/${uid}`).once('value').then(s=>s.val());
    if (!player) {
      const cards = Object.keys(cardMeta);
      const cid = cards[Math.floor(Math.random()*cards.length)];
      player = {
        cardId: cid,
        faction: cardMeta[cid].faction,
        weapons: ["tommy-gun","bulletproof_vest"],
        stats: { health:100, energy:50, experience:0 },
        abilities: { quick_shot:{ attackBonus:5, cooldown:30 } },
        lastUpdated: new Date().toISOString()
      };
      await db.ref(`/players/${uid}`).set(player);
    }

    // fetch definitions
    async function fetchJSON(p){ let r=await fetch(p); if(!r.ok) throw r.status; return r.json(); }
    const wdefs = await Promise.all(player.weapons.map(id=> fetchJSON(`${ASSETS_BASE_URL}/assets/json/weapons/${id}.json`)));
    let fac;
    try { fac = await db.ref(`/factions/${player.faction}`).once('value').then(s=>s.val()); }
    catch{ fac={bonuses:{attack:0,defense:0}}; }
    
    // compute stats
    const lvl = xpToLevel(player.stats.experience);
    let atk=0, def=0;
    wdefs.forEach(w=>{
      atk += w.baseStats.attack + lvl*w.scaling.attackPerLevel;
      def += w.baseStats.defense + lvl*w.scaling.defensePerLevel;
    });
    atk += fac.bonuses.attack; def += fac.bonuses.defense;

    // render
    const root = document.getElementById('game-root');
    const imgBadge = Object.assign(document.createElement('img'), {
      src:`${ASSETS_BASE_URL}/assets/factions/${player.faction}.png`,
      style:'width:40px;display:block;margin:0 auto;'
    });
    const imgCard = Object.assign(document.createElement('img'), {
      src:`${ASSETS_BASE_URL}/assets/cards/${player.cardId}.png`,
      style:'width:100%;border-radius:4px;'
    });
    const stats = document.createElement('div');
    stats.style='font-family:monospace;text-align:center;margin:8px 0;';
    stats.innerHTML=`
      <p>Level: ${lvl}</p>
      <p>HP: ${player.stats.health}</p>
      <p>EN: ${player.stats.energy}</p>
      <p>XP: ${player.stats.experience}</p>
      <p>ATK: ${atk}</p>
      <p>DEF: ${def}</p>
    `;
    const wdiv = document.createElement('div');
    wdiv.style='text-align:center;';
    wdefs.forEach(w=>{
      const wi=document.createElement('img');
      wi.src=`${ASSETS_BASE_URL}/assets/weapons/${w.id}.png`;
      wi.title=`${w.name}\nATK:${w.baseStats.attack+lvl*w.scaling.attackPerLevel} DEF:${w.baseStats.defense+lvl*w.scaling.defensePerLevel}`;
      wi.style='width:30px;margin:0 4px;';
      wdiv.append(wi);
    });

    root.append(imgBadge, imgCard, stats, wdiv);
  })();
  </script>
</body>
</html>
