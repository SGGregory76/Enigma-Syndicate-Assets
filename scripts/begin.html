<script>
// --- Begin inline game-engine.umd.js ---
;(function(window) {
  // Firebase config (Realtime DB)
  const firebaseConfig = {
    apiKey: "AIzaSyCiFF0giW60YhEF9MPF8RMMETXkNW9vv2Y",
    authDomain: "sandbox-mafia.firebaseapp.com",
    databaseURL: "https://sandbox-mafia-default-rtdb.firebaseio.com",
    projectId: "sandbox-mafia",
    storageBucket: "sandbox-mafia.firebasestorage.app",
    messagingSenderId: "966783573980",
    appId: "1:966783573980:web:a07a7b66d7d9a057dab919",
    measurementId: "G-YYY9ZJ0P73"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();
  let currentUserUid = null;

  // XP → Level
  function xpToLevel(xp) {
    return Math.floor(xp / 100) + 1;
  }

  // Auth
  function initAuth() {
    return new Promise((res, rej) => {
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUserUid = user.uid;
          res(user);
        } else {
          auth.signInAnonymously()
            .then(cred => {
              currentUserUid = cred.user.uid;
              res(cred.user);
            })
            .catch(rej);
        }
      });
    });
  }

  // Fetch helpers
  function fetchPlayer(uid) {
    return db.ref(`/players/${uid}`).once('value').then(s => s.val());
  }
  function fetchEncounter(id) {
    return db.ref(`/encounters/${id}`).once('value').then(s => s.val());
  }
  function fetchFaction(id) {
    return db.ref(`/factions/${id}`).once('value').then(s => s.val());
  }
  async function fetchWeapon(id) {
    const resp = await fetch(
      `${window.ASSETS_BASE_URL}/assets/json/weapons/${id}.json`
    );
    if (!resp.ok) throw new Error(`Weapon JSON load failed: ${resp.status}`);
    return resp.json();
  }

  // Render card
  async function renderCardContainer(containerId, playerData) {
    const c = document.getElementById(containerId);
    c.innerHTML = '';
    const lvl = xpToLevel(playerData.stats.experience);
    const defs = await Promise.all(
      playerData.weapons.map(w => fetchWeapon(w))
    );
    let atk=0, def=0;
    defs.forEach(w => {
      atk += w.baseStats.attack + lvl*w.scaling.attackPerLevel;
      def += w.baseStats.defense + lvl*w.scaling.defensePerLevel;
    });
    const fac = await fetchFaction(playerData.faction);
    atk += fac.bonuses?.attack||0;
    def += fac.bonuses?.defense||0;

    // Build UI
    const badge = Object.assign(document.createElement('img'), {
      src: `${window.ASSETS_BASE_URL}/assets/factions/${playerData.faction}.png`,
      className: 'faction-badge'
    });
    const card = Object.assign(document.createElement('img'), {
      src: `${window.ASSETS_BASE_URL}/assets/cards/${playerData.cardId}.png`,
      className: 'card-image'
    });
    const stats = document.createElement('div');
    stats.className = 'stats-panel';
    stats.innerHTML = `
      <p>Level: ${lvl}</p>
      <p>Health: ${playerData.stats.health}</p>
      <p>Energy: ${playerData.stats.energy}</p>
      <p>XP: ${playerData.stats.experience}</p>
      <p>Total ATK: ${atk}</p>
      <p>Total DEF: ${def}</p>
    `;
    const weaponsDiv = document.createElement('div');
    weaponsDiv.className = 'weapons-panel';
    defs.forEach(w => {
      const img = document.createElement('img');
      img.src   = `${window.ASSETS_BASE_URL}/assets/weapons/${w.id}.png`;
      img.title = `${w.name} — ATK:${w.baseStats.attack + lvl*w.scaling.attackPerLevel}, DEF:${w.baseStats.defense + lvl*w.scaling.defensePerLevel}`;
      weaponsDiv.append(img);
    });

    c.append(badge, card, stats, weaponsDiv);
  }

  // Init entry
  async function initGame(containerId) {
    await initAuth();
    const player = await fetchPlayer(currentUserUid);
    await renderCardContainer(containerId, player);
  }

  window.initGame = initGame;
})(window);
// --- End inline game-engine.umd.js ---
</script>
